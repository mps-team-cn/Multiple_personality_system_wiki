name: PR è´¨é‡æ£€æŸ¥

on:
  pull_request:
    paths:
      - 'docs/entries/*.md'
      - 'docs/**/*.md'

permissions:
  contents: read
  pull-requests: write  # å…è®¸è¯„è®º PR

jobs:
  check-quality:
    name: æ£€æŸ¥è¯æ¡è´¨é‡
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: æ£€æŸ¥é“¾æ¥è§„èŒƒ
        id: check_links
        run: |
          echo "ğŸ”— æ£€æŸ¥é“¾æ¥è§„èŒƒ..."
          echo ""

          # æ£€æŸ¥ä¿®æ”¹çš„ Markdown æ–‡ä»¶
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.md$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "âœ… æ²¡æœ‰ Markdown æ–‡ä»¶å˜æ›´"
            exit 0
          fi

          echo "ğŸ“ æ£€æŸ¥ä»¥ä¸‹æ–‡ä»¶ï¼š"
          echo "$CHANGED_FILES"
          echo ""

          # è¿è¡Œé“¾æ¥æ£€æŸ¥
          FAILED=0
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              echo "æ£€æŸ¥: $file"
              if ! python3 tools/check_links.py "$file"; then
                FAILED=1
              fi
            fi
          done

          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ é“¾æ¥æ£€æŸ¥å¤±è´¥ï¼"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ“‹ é“¾æ¥è§„èŒƒï¼š"
            echo "  âœ… è¯æ¡é—´é“¾æ¥ï¼šç›´æ¥ä½¿ç”¨æ–‡ä»¶å"
            echo "     ç¤ºä¾‹ï¼š[DID](DID.md)"
            echo ""
            echo "  âœ… è¯æ¡â†’å…¶ä»–ç›®å½•ï¼šä½¿ç”¨ ../ ç›¸å¯¹è·¯å¾„"
            echo "     ç¤ºä¾‹ï¼š[è´¡çŒ®æŒ‡å—](../contributing/index.md)"
            echo ""
            echo "  âœ… å…¶ä»–ç›®å½•â†’è¯æ¡ï¼šä½¿ç”¨ ../entries/ è·¯å¾„"
            echo "     ç¤ºä¾‹ï¼š[DID](../entries/DID.md)"
            echo ""
            echo "  âŒ ç¦æ­¢ï¼šç»å¯¹è·¯å¾„"
            echo "     é”™è¯¯ç¤ºä¾‹ï¼š[DID](/docs/entries/DID.md)"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi

          echo ""
          echo "âœ… æ‰€æœ‰é“¾æ¥ç¬¦åˆè§„èŒƒ"

      - name: æ£€æŸ¥ Frontmatter
        run: |
          echo "ğŸ“‹ æ£€æŸ¥ Frontmatter æ ¼å¼..."
          echo ""

          # æ£€æŸ¥è¯æ¡ç›®å½•ä¸­çš„æ–‡ä»¶
          CHANGED_ENTRIES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^docs/entries/.*\.md$' || true)

          if [ -z "$CHANGED_ENTRIES" ]; then
            echo "âœ… æ²¡æœ‰è¯æ¡æ–‡ä»¶å˜æ›´"
            exit 0
          fi

          FAILED=0
          for file in $CHANGED_ENTRIES; do
            if [ ! -f "$file" ]; then
              continue
            fi

            echo "æ£€æŸ¥: $file"

            # æ£€æŸ¥æ˜¯å¦æœ‰ Frontmatter
            if ! head -1 "$file" | grep -q '^---$'; then
              echo "  âŒ ç¼ºå°‘ Frontmatter"
              FAILED=1
              continue
            fi

            # æå– Frontmatter å†…å®¹
            FRONTMATTER=$(awk '/^---$/{if(++n==2)exit;next}n==1' "$file")

            # æ£€æŸ¥å¿…éœ€å­—æ®µ
            if ! echo "$FRONTMATTER" | grep -q '^title:'; then
              echo "  âŒ ç¼ºå°‘ title å­—æ®µ"
              FAILED=1
            fi

            if ! echo "$FRONTMATTER" | grep -q '^topic:'; then
              echo "  âŒ ç¼ºå°‘ topic å­—æ®µ"
              FAILED=1
            fi

            if ! echo "$FRONTMATTER" | grep -q '^tags:'; then
              echo "  âŒ ç¼ºå°‘ tags å­—æ®µ"
              FAILED=1
            fi

            if [ $FAILED -eq 0 ]; then
              echo "  âœ… Frontmatter æ ¼å¼æ­£ç¡®"
            fi
          done

          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ Frontmatter æ£€æŸ¥å¤±è´¥ï¼"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ“‹ å¿…éœ€å­—æ®µï¼š"
            echo "  - title: è¯æ¡æ ‡é¢˜"
            echo "  - topic: è¯æ¡ä¸»é¢˜ï¼ˆç”¨äº Guide æ˜ å°„ï¼‰"
            echo "  - tags: åˆ†ç±»æ ‡ç­¾åˆ—è¡¨"
            echo ""
            echo "ğŸ“ æ³¨æ„ï¼šupdated å­—æ®µä¼šåœ¨åˆå¹¶åè‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨å¡«å†™"
            echo ""
            echo "ğŸ“š ä¸»é¢˜ä¸ Guide æ˜ å°„è¯·å‚è€ƒï¼š"
            echo "    AGENTS.md#ğŸ“š-è¯æ¡ä¸»é¢˜ä¸-guide-æ˜ å°„è¡¨"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi

          echo ""
          echo "âœ… æ‰€æœ‰ Frontmatter æ ¼å¼æ­£ç¡®"

      - name: æ£€æŸ¥ç»“æœæ‘˜è¦
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š PR æ£€æŸ¥å®Œæˆ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥åˆå¹¶"
            echo ""
            echo "ğŸ’¡ æç¤ºï¼š"
            echo "  - æ—¶é—´æˆ³ä¼šåœ¨åˆå¹¶åˆ° main åè‡ªåŠ¨æ›´æ–°"
            echo "  - æ ¼å¼é—®é¢˜ä¼šåœ¨åˆå¹¶åè‡ªåŠ¨ä¿®å¤"
          else
            echo "âŒ æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤é—®é¢˜åé‡æ–°æäº¤"
            echo ""
            echo "ğŸ“– å‚è€ƒæ–‡æ¡£ï¼š"
            echo "  - è¯æ¡æ¨¡æ¿ï¼šdocs/TEMPLATE_ENTRY.md"
            echo "  - è´¡çŒ®æŒ‡å—ï¼šdocs/contributing/"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
