name: è‡ªåŠ¨ä¿®å¤è¯æ¡

on:
  push:
    branches:
      - main
    paths:
      - 'docs/entries/*.md'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  auto-fix:
    name: æ›´æ–°æ—¶é—´æˆ³å¹¶ä¿®å¤æ ¼å¼
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ï¼Œä»¥ä¾¿ git log å·¥ä½œ
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: è¿è¡Œæ—¶é—´æˆ³æ›´æ–°è„šæœ¬
        run: |
          echo "ğŸ“… æ›´æ–°è¯æ¡æ—¶é—´æˆ³..."
          python3 tools/update_git_timestamps.py --verbose

      - name: æ£€æŸ¥é“¾æ¥è§„èŒƒï¼ˆä¿®å¤å‰ï¼‰
        run: |
          echo "ğŸ”— æ£€æŸ¥é“¾æ¥è§„èŒƒï¼ˆä¿®å¤å‰ï¼‰..."
          python3 tools/check_links.py docs/entries/ || {
            echo "âš ï¸ å‘ç°é“¾æ¥è¿è§„ï¼Œå°†åœ¨æ ¼å¼ä¿®å¤åé‡æ–°æ£€æŸ¥"
            exit 0
          }

      - name: è¿è¡Œ Markdown æ ¼å¼ä¿®å¤
        run: |
          echo "ğŸ”§ ä¿®å¤ Markdown æ ¼å¼..."
          python3 tools/fix_markdown.py docs/entries/ --verbose

      - name: æ£€æŸ¥é“¾æ¥è§„èŒƒï¼ˆä¿®å¤åï¼‰
        run: |
          echo "ğŸ”— æ£€æŸ¥é“¾æ¥è§„èŒƒï¼ˆä¿®å¤åï¼‰..."
          if ! python3 tools/check_links.py docs/entries/; then
            echo ""
            echo "âŒ é“¾æ¥æ£€æŸ¥å¤±è´¥ï¼è¯·ä¿®æ­£è¿è§„é“¾æ¥åé‡æ–°æäº¤ã€‚"
            echo ""
            echo "é“¾æ¥è§„èŒƒï¼š"
            echo "  - è¯æ¡é—´é“¾æ¥ï¼šç›´æ¥ä½¿ç”¨æ–‡ä»¶åï¼ˆå¦‚ DID.mdï¼‰"
            echo "  - è¯æ¡â†’å…¶ä»–ç›®å½•ï¼šä½¿ç”¨ ../ ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ ../contributing/index.mdï¼‰"
            echo "  - å…¶ä»–ç›®å½•â†’è¯æ¡ï¼šä½¿ç”¨ ../entries/ è·¯å¾„ï¼ˆå¦‚ ../entries/DID.mdï¼‰"
            echo "  - ç¦æ­¢ï¼šç»å¯¹è·¯å¾„ï¼ˆå¦‚ /docs/entries/DID.mdï¼‰"
            echo ""
            exit 1
          fi

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        id: check_changes
        run: |
          if git diff --quiet docs/entries/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… æ‰€æœ‰æ–‡ä»¶å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æäº¤"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ–°"
            echo ""
            echo "å˜æ›´æ‘˜è¦:"
            git diff --stat docs/entries/
          fi

      - name: é…ç½® Git
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: æäº¤æ›´æ–°
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add docs/entries/*.md
          git commit -m "chore: è‡ªåŠ¨æ›´æ–°è¯æ¡æ—¶é—´æˆ³å’Œæ ¼å¼

          - æ ¹æ® Git å†å²æ›´æ–° updated å­—æ®µ
          - ä¿®å¤ Markdown æ ¼å¼é—®é¢˜

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>"

      - name: æ¨é€æ›´æ”¹
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git push
