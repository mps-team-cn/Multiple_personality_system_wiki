name: IndexNow æ¨é€

on:
  # åœ¨ä¸»åˆ†æ”¯éƒ¨ç½²åè§¦å‘
  workflow_run:
    workflows: ["pages-build-deployment"]
    types:
      - completed
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'æ¨é€æ¨¡å¼'
        required: true
        default: 'recent'
        type: choice
        options:
          - recent  # ä»…æ¨é€æœ€è¿‘ä¿®æ”¹çš„è¯æ¡
          - all     # æ¨é€æ‰€æœ‰ URL

permissions:
  contents: read

jobs:
  indexnow:
    name: æäº¤ URL åˆ° IndexNow
    runs-on: ubuntu-latest
    # ä»…åœ¨éƒ¨ç½²æˆåŠŸåæ‰§è¡Œ
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²ä»¥ä¾¿æ£€æµ‹æœ€è¿‘ä¿®æ”¹

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests

      - name: æ„å»ºç«™ç‚¹
        run: |
          echo "ğŸ“¦ å®‰è£… MkDocs..."
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          echo "ğŸ—ï¸ æ„å»ºç«™ç‚¹ä»¥ç”Ÿæˆ sitemap.xml..."
          mkdocs build

      - name: éªŒè¯ IndexNow å¯†é’¥æ–‡ä»¶
        run: |
          echo "ğŸ” éªŒè¯ IndexNow å¯†é’¥æ–‡ä»¶å¯è®¿é—®æ€§..."
          KEY_URL="https://wiki.mpsteam.cn/21560e3c9db64767914ef22b96cd7660.txt"

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¿”å› 200
          if ! curl -fsSI "$KEY_URL" >/dev/null; then
            echo "âœ— å¯†é’¥æ–‡ä»¶ä¸å¯è®¿é—®: $KEY_URL"
            exit 1
          fi

          # éªŒè¯å†…å®¹å®Œå…¨åŒ¹é…ï¼ˆæ— æ¢è¡Œ/BOMï¼‰
          REMOTE=$(curl -fsS "$KEY_URL")
          KEY="21560e3c9db64767914ef22b96cd7660"
          if [ "$REMOTE" != "$KEY" ]; then
            echo "âœ— å¯†é’¥å†…å®¹ä¸åŒ¹é…ï¼ˆå¯èƒ½æœ‰æ¢è¡Œæˆ– BOMï¼‰"
            exit 1
          fi

          echo "âœ“ å¯†é’¥æ–‡ä»¶éªŒè¯é€šè¿‡"

      - name: æ¨é€åˆ° IndexNow (æœ€è¿‘ä¿®æ”¹)
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.mode == 'recent' }}
        run: |
          echo "ğŸ“¤ æäº¤æœ€è¿‘ä¿®æ”¹çš„ 50 ä¸ªè¯æ¡åˆ° IndexNow..."
          python3 tools/submit_to_indexnow.py --recent 50

      - name: æ¨é€åˆ° IndexNow (å…¨éƒ¨)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.mode == 'all' }}
        run: |
          echo "ğŸ“¤ æäº¤æ‰€æœ‰ URL åˆ° IndexNow..."
          python3 tools/submit_to_indexnow.py --all

      - name: æ¨é€ç»“æœ
        if: always()
        run: |
          echo "âœ“ IndexNow æ¨é€å®Œæˆ"
          echo "ğŸ“Š æ”¯æŒçš„æœç´¢å¼•æ“: Bing, Yandex, Naver, Seznam"
          echo "â±ï¸ é€šå¸¸åœ¨æ•°å°æ—¶å†…å®Œæˆç´¢å¼•æ›´æ–°"
